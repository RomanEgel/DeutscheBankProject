<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:include="common/common :: common('uploadValues')">
    <th:block th:fragment="uploadValues">
        <label>Choose period that you're interested in</label>
        <div class="input-group mb-3">
            <input id="date1" type="date"  name="fromDate" >
            <input id="date2" type="date"  name="toDate">
        </div>
        <button onclick="loadValues()" id="button" type="button" class="btn btn-primary">Load brent oil history</button>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript">
            window.onload = findOutRange;

            function findOutRange() {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", '/getRange', true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        values = xhr.responseText;
                        setRange(values);
                    }
                };
                xhr.send();

                function setRange(values) {
                    var vals = JSON.parse(values);
                    var d1 = new Date(Date.parse(vals[0])).toISOString().substr(0,10);
                    var d2 = new Date(Date.parse(vals[1])).toISOString().substr(0,10);

                    document.getElementById("date1").min = d1;
                    document.getElementById("date1").max = d2;
                    document.getElementById("date2").min = d1;
                    document.getElementById("date2").max = d2;

                }
            }
        </script>
        <script type="text/javascript">
            google.charts.load('current', {'packages': ['corechart']});
            google.charts.setOnLoadCallback(drawChart);

            function loadValues() {
                var date1, date2;
                var values;
                date1 = document.getElementById("date1").value;
                date2 = document.getElementById("date2").value;
                var str = '{ "fromDate": "' + date1 + '", "toDate": "' + date2 + '" }';
                var jsonDates = JSON.parse(str);
                var xhr = new XMLHttpRequest();
                xhr.open("POST", '/uploadValues', true);
                xhr.setRequestHeader('Content-type', 'application/json');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        values = xhr.responseText;
                        button.innerHTML = 'Готово!';
                        drawChart(values);
                    }
                };
                xhr.send(JSON.stringify(jsonDates));
                button.innerHTML = 'Loading...'; // (2)
                button.disabled = true;
            }

            function drawChart(values) {
                var stringJson;
                var numberOfValues = 0;

                var jsonValues = JSON.parse(values, function (key, value) {
                    if(key == "id"){
                        numberOfValues++;
                        return new Date(Date.parse(value.price_timestamp));
                    } else{
                        return value;
                    }
                });

                Date.prototype.daysInMonth = function() {
                    return 33 - new Date(this.getFullYear(), this.getMonth(), 33).getDate();
                };

                var beginDate = new Date(jsonValues[0].id);
                beginDate.setDate(0);


                var endDate = new Date(jsonValues[numberOfValues-1].id);
                var daysInMonth = endDate.daysInMonth();
                endDate.setDate(daysInMonth);

                stringJson = JSON.stringify(jsonValues);
                console.log(stringJson);

                var data = new google.visualization.DataTable();
                // Add columns
                data.addColumn('date', 'Date');
                data.addColumn('number', 'rate');
                for(i=0;i<numberOfValues;i++){
                    data.addRow([jsonValues[i].id,jsonValues[i].price]);
                }


                var options = {
                    title: 'Brent Oil Currencies',
                    curveType: 'function',
                    legend: {position: 'bottom'},
                    hAxis: {
                        title: "dates",
                        viewWindow: {
                            min: beginDate,
                            max: endDate
                        }
                    },
                    vAxis: {
                        title: "Values"
                    }
                };

                var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

                chart.draw(data, options);
                button.innerHTML = 'load brent oil history';
                button.disabled = false;
            }

        </script>
        <div id="curve_chart" style="width: 900px; height: 500px"></div>
    </th:block>
</th:block>
</html>